# Приложение Celery Parser

Это простое веб-приложение, построенное с использованием FastAPI и Celery, предназначенное для парсинга URL-адресов. Оно использует Redis в качестве брокера сообщений и для распределенной блокировки (Redlock) для ограничения параллельных задач парсинга для заданного URL.

## Возможности

-	**FastAPI**: Предоставляет RESTful API для создания и проверки задач парсинга.
-	**Celery**: Асинхронная очередь задач для фоновой обработки парсинга URL.
-	**Redis**: Используется как брокер сообщений для Celery, так и для реализации распределенного семафора (Redlock) для контроля параллелизма.
-	**Контроль параллелизма**: Ограничивает количество параллельных задач парсинга для одного URL до 3, при этом остальные задачи ожидают освобождения слота.

## Предварительные требования

Прежде чем начать, убедитесь, что у вас установлено следующее:

-	[Docker](https://docs.docker.com/get-docker/)
-	[Docker Compose](https://docs.docker.com/compose/install/)

## Начало работы

1.	**Клонируйте репозиторий** (если вы еще этого не сделали):

    ```bash
    git clone https://github.com/teoofrast/parser.git
    cd parser
    ```

2.	**Соберите и запустите Docker-контейнеры**:

    Эта команда соберет Docker-образы для вашего приложения, Celery-воркера и Redis, а затем запустит все сервисы.

    ```bash
    docker-compose up --build -d
    ```

    *	`--build`: Собирает образы перед запуском контейнеров. Используйте это, когда вы вносите изменения в `Dockerfile` или `requirements.txt`.
    *	`-d`: Запускает контейнеры в отсоединенном режиме (в фоновом режиме).

3.	**Убедитесь, что сервисы запущены**:

    ```bash
    docker-compose ps
    ```

    Вы должны увидеть сервисы `app`, `celery_worker` и `redis` в рабочем состоянии.

## API-эндпоинты

Приложение FastAPI будет доступно по адресу `http://localhost:8000`.

### 1. Создание задачи парсинга

-	**Эндпоинт**: `POST /tasks/`
-	**Описание**: Отправляет URL для асинхронного парсинга.
-	**Метод**: `POST`
-	**Content-Type**: `application/x-www-form-urlencoded`
-	**Данные формы**: `url` (строка, обязательный)

**Пример использования `curl`:**

```bash
curl -X POST \
  http://localhost:8000/tasks/ \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "url=https://example.com"
```

**Пример ответа (201 Created):**

```json
{
  "task_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
}
```

### 2. Получение статуса задачи

-	**Эндпоинт**: `GET /tasks/{task_id}`
-	**Описание**: Получает текущий статус и результат задачи парсинга.
-	**Метод**: `GET`

**Пример использования `curl`:**

```bash
curl -X GET http://localhost:8000/tasks/a1b2c3d4-e5f6-7890-1234-567890abcdef
```

**Пример ответа (200 OK - Задача в процессе):**

```json
{
  "status": "PENDING",
  "data": null
}
```

**Пример ответа (200 OK - Задача успешно завершена):**

```json
{
  "status": "SUCCESS",
  "data": "<html>...распарсенное содержимое...</html>"
}
```

**Пример ответа (200 OK - Задача завершилась с ошибкой):**

```json
{
  "status": "FAILURE",
  "data": "Response403Error('Error when get response to https://example.com')"
}
```

### Использование Postman

Для Postman вам нужно:

1.	**Для `POST /tasks/`:**
    *	Установите метод на `POST`.
    *	Введите URL: `http://localhost:8000/tasks/`.
    *	Перейдите на вкладку `Body`, выберите `x-www-form-urlencoded`.
    *	Добавьте ключ `url` со значением вашего URL.
    *	Нажмите `Send`.

2.	**Для `GET /tasks/{task_id}`:**
    *	Установите метод на `GET`.
    *	Введите URL: `http://localhost:8000/tasks/{your_task_id}` (замените `{your_task_id}` на ID, полученный из POST-запроса).
    *	Нажмите `Send`.

## Запуск тестов

Для запуска модульных и интеграционных тестов приложения:

```bash
docker-compose exec app pytest -v tests/
```

Эта команда выполнит `pytest` внутри контейнера `app`, запуская все тесты, расположенные в директории `tests/`.

## Остановка приложения

Чтобы остановить и удалить запущенные контейнеры, сети и тома (если они явно не определены как внешние):

```bash
docker-compose down
```

Чтобы остановить контейнеры, но сохранить их для последующего перезапуска:

```bash
docker-compose stop
```